!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e():"function"==typeof define&&define.amd?define("DatasourceConector",[],e):"object"==typeof exports?exports.DatasourceConector=e():t.DatasourceConector=e()}(window,function(){return function(t){var e={};function o(r){if(e[r])return e[r].exports;var n=e[r]={i:r,l:!1,exports:{}};return t[r].call(n.exports,n,n.exports,o),n.l=!0,n.exports}return o.m=t,o.c=e,o.d=function(t,e,r){o.o(t,e)||Object.defineProperty(t,e,{configurable:!1,enumerable:!0,get:r})},o.r=function(t){Object.defineProperty(t,"__esModule",{value:!0})},o.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return o.d(e,"a",e),e},o.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},o.p="",o(o.s=0)}([function(t,e){(()=>{let t=Handsontable.plugins.BasePlugin;class e{constructor(t){this.object=t}_serialie(t,e){let o,r=[];for(o in t)if(t.hasOwnProperty(o)){let n=e?e+"["+o+"]":o,s=t[o];r.push(null!==s&&"object"==typeof s?this._serialie(s,n):encodeURIComponent(n)+"="+encodeURIComponent(s))}return r.join("&")}string(){return void 0===this.object?"":"?"+this._serialie(this.object)}}class o{constructor(){this.url="",this.method="GET",this.headers={"Content-Type":"application/json"},this.body={}}}Handsontable.plugins.registerPlugin("DataSourceConnector",class extends t{constructor(t){super(t),this.controllerUrl=""}isEnabled(){return this.controllerUrl=this.hot.getSettings().dataSourceConnector.controllerUrl,!!this.hot.getSettings().dataSourceConnector}enablePlugin(){this.addHook("beforeColumnSort",()=>!1),this.addHook("beforeFilter",()=>!1),this.addHook("afterRender",t=>{}),this.addHook("afterInit",()=>this.onAfterInit()),this.addHook("afterChange",(t,e)=>this.onAfterChange(t,e)),this.addHook("afterColumnSort",(t,e)=>this.onAfterColumnSort(t,e)),this.addHook("afterCreateRow",(t,e,o)=>this.onAfterCreateRow(t,e,o)),this.addHook("afterCreateCol",(t,e,o)=>this.onAfterCreateCol(t,e,o)),this.addHook("afterColumnMove",(t,e)=>this.onAfterColumnMove(t,e)),this.addHook("afterFilter",t=>this.onAfterFilter(t)),super.enablePlugin()}onAfterFilter(t){let e=[];if(t.length>0){for(let o=0;o<t.length;o++){switch(operator=this.hot.getPlugin("filters").conditionCollection.columnTypes[t[o].column],operator){case"conjunction":operator=["and"];break;case"disjunction":operator=["or"];break;case"disjunctionAndVariable":operator=["or","and"]}for(let r=0;r<t[o].conditions.length;r++){if(operator[r]&&(t[o].conditions[r].operator=operator[r]),0!=t[o].conditions[r].args.length)if("string"==typeof t[o].conditions[r].args[0])e.push("["+this.colHeaders[t[o].column]+"]["+t[o].conditions[r].name+"]="+t[o].conditions[r].args[0]);else for(let n=0;n<t[o].conditions[r].args[0].length;n++)e.push("["+this.colHeaders[t[o].column]+"]["+t[o].conditions[r].name+"]="+t[o].conditions[r].args[0][n]);else e.push("["+this.colHeaders[t[0].column]+"]["+t[o].conditions[r].name+"]=true");r<t[o].conditions.length-1&&(tempOperator=t[o].conditions[r].operator||"and",e.push("["+this.colHeaders[t[o].column]+"][operator]="+tempOperator))}operatorWithVariable=!1}var o="?"+e.join("&");console.log(o)}}onAfterColumnMove(t,e){var o={columns:t,target:e};this._post(this.controllerUrl+"/aftercolumnmove",o)}onAfterCreateCol(t,e,o){var r={index:t,amount:e,source:o};this._post(this.controllerUrl+"/aftercreatecol",r).then(t=>t)}onAfterCreateRow(t,e,o){var r={index:t,amount:e,source:o};this._post(this.controllerUrl+"/aftercreaterow",r).then(t=>t)}onAfterColumnSort(t,o){let r=new e({column:this.colHeaders[t],order:o});this._get(controllerUrl+"/aftercolumnsort"+r.string()).then(t=>{this._loadData(reponse)})}_loadData(t){let e=t.data,o=[];for(let t=0;t<e.length;t++){let r=[];for(let o in e[t])r.push(e[t][o]);o.push(r)}this.hot.loadData(o);let r=[];for(let t in e[0])r.push(t);for(let o=0;o<e.length;o++)for(let n=0;n<r.length;n++)this.hot.setCellMeta(o,n,"row_id",e[o][t.rowId]),this.hot.setCellMeta(o,n,"col_id",r[n])}onAfterInit(){this._get(this.controllerUrl+"/settings").then(t=>{this.hot.updateSettings(t.data)}),this._get(this.controllerUrl+"/data").then(t=>{this._loadData(t)})}disablePlugin(){super.disablePlugin()}updatePlugin(){this.disablePlugin(),this.enablePlugin(),super.updatePlugin()}onAfterChange(t,e){if(t){let o=[];for(let e=0;e<t.length;e++){let r=this.hot.getCellMeta(t[e][0],t[e][1]),n={row:r.row_id,column:r.col_id,oldValue:t[e][2],newValue:t[e][3],meta:r};delete n.meta.instance,o.push(n)}this._post(this.controllerUrl+"/afterchange",{changes:o,source:e})}}destroy(){super.destroy()}onDataSend(t){let e=this.hot.getSettings().dataSourceConnector.onDataSend;"function"==typeof e&&e(t)}_post(t,e){let r=new o;return r.url=t,r.method="POST",r.body=JSON.stringify(e),this._request(r).then(t=>(this.onDataSend({reqest:r,response:JSON.parse(t)}),JSON.parse(t)))}_get(t){var e=new o;return e.url=t,this._request(e).then(t=>(this.onDataSend({reqest:e,response:JSON.parse(t)}),JSON.parse(t)))}_request(t){return new Promise((e,o)=>{let r=new XMLHttpRequest;r.open(t.method||"GET",t.url),t.headers&&Object.keys(t.headers).forEach(e=>{r.setRequestHeader(e,t.headers[e])}),r.onload=(()=>{r.status>=200&&r.status<300?e(r.response):o(r.statusText)}),r.onerror=(()=>o(r.statusText)),r.send(t.body)})}})})()}]).default});
//# sourceMappingURL=datasource-connector.js.map