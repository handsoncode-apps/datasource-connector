!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define("DatasourceConector",[],t):"object"==typeof exports?exports.DatasourceConector=t():e.DatasourceConector=t()}(window,function(){return function(e){var t={};function o(r){if(t[r])return t[r].exports;var n=t[r]={i:r,l:!1,exports:{}};return e[r].call(n.exports,n,n.exports,o),n.l=!0,n.exports}return o.m=e,o.c=t,o.d=function(e,t,r){o.o(e,t)||Object.defineProperty(e,t,{configurable:!1,enumerable:!0,get:r})},o.r=function(e){Object.defineProperty(e,"__esModule",{value:!0})},o.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return o.d(t,"a",t),t},o.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},o.p="",o(o.s=0)}([function(e,t,o){"use strict";o.r(t);t.default=(e=>{let t=Handsontable.plugins.BasePlugin;class o{constructor(e){this.object=e}_serialie(e,t){let o,r=[];for(o in e)if(e.hasOwnProperty(o)){let n=t?t+"["+o+"]":o,s=e[o];r.push(null!==s&&"object"==typeof s?this._serialie(s,n):encodeURIComponent(n)+"="+encodeURIComponent(s))}return r.join("&")}string(){return void 0===this.object?"":"?"+this._serialie(this.object)}}class r{constructor(){this.url="",this.method="GET",this.headers=[],this.body={}}}return new class extends t{constructor(e){super(e),this.controllerUrl=this.hot.getSettings().dataSourceConnector.controllerUrl}isEnabled(){return console.log("enabled:",!!this.hot.getSettings().dataSourceConnector),!!this.hot.getSettings().dataSourceConnector}enablePlugin(){this.addHook("beforeColumnSort",()=>!1),this.addHook("beforeFilter",()=>!1),this.addHook("afterRender",e=>{}),this.addHook("afterInit",()=>this.onAfterInit()),this.addHook("afterChange",(e,t)=>this.onAfterChange(e,t)),this.addHook("afterColumnSort",(e,t)=>this.onAfterColumnSort(e,t)),this.addHook("afterCreateRow",(e,t,o)=>this.onAfterCreateRow(e,t,o)),this.addHook("afterCreateCol",(e,t,o)=>this.onAfterCreateCol(e,t,o)),this.addHook("afterColumnMove",(e,t)=>this.onAfterColumnMove(e,t)),this.addHook("afterFilter",e=>this.onAfterFilter(e)),super.enablePlugin()}onAfterFilter(e){let t=[];if(e.length>0){for(let o=0;o<e.length;o++){switch(operator=this.hot.getPlugin("filters").conditionCollection.columnTypes[e[o].column],operator){case"conjunction":operator=["and"];break;case"disjunction":operator=["or"];break;case"disjunctionAndVariable":operator=["or","and"]}for(let r=0;r<e[o].conditions.length;r++){if(operator[r]&&(e[o].conditions[r].operator=operator[r]),0!=e[o].conditions[r].args.length)if("string"==typeof e[o].conditions[r].args[0])t.push("["+this.colHeaders[e[o].column]+"]["+e[o].conditions[r].name+"]="+e[o].conditions[r].args[0]);else for(let n=0;n<e[o].conditions[r].args[0].length;n++)t.push("["+this.colHeaders[e[o].column]+"]["+e[o].conditions[r].name+"]="+e[o].conditions[r].args[0][n]);else t.push("["+this.colHeaders[e[0].column]+"]["+e[o].conditions[r].name+"]=true");r<e[o].conditions.length-1&&(tempOperator=e[o].conditions[r].operator||"and",t.push("["+this.colHeaders[e[o].column]+"][operator]="+tempOperator))}operatorWithVariable=!1}var o="?"+t.join("&");console.log(o)}}onAfterColumnMove(e,t){var o={columns:e,target:t};this._post(this.controllerUrl+"/aftercolumnmove",o)}onAfterCreateCol(e,t,o){var r={index:e,amount:t,source:o};this._post(this.controllerUrl+"/aftercreatecol",r).then(e=>e)}onAfterCreateRow(e,t,o){var r={index:e,amount:t,source:o};this._post(this.controllerUrl+"/aftercreaterow",r).then(e=>e)}onAfterColumnSort(e,t){let r=new o({column:this.colHeaders[e],order:t});this._get(controllerUrl+"/aftercolumnsort"+r.string()).then(e=>{this._loadData(reponse)})}_loadData(e){let t=e.data,o=[];for(let e=0;e<t.length;e++){let r=[];for(let o in t[e])r.push(t[e][o]);o.push(r)}this.hot.loadData(o);let r=[];for(let e in t[0])r.push(e);for(let o=0;o<t.length;o++)for(let n=0;n<r.length;n++)this.hot.setCellMeta(o,n,"row_id",t[o][e.rowId]),this.hot.setCellMeta(o,n,"col_id",r[n])}onAfterInit(){console.log("after init"),this._get(this.controllerUrl+"/settings").then(e=>{this.hot.updateSettings(e.data)}),this._get(this.controllerUrl+"/data").then(e=>{this._loadData(e)})}disablePlugin(){super.disablePlugin()}updatePlugin(){this.disablePlugin(),this.enablePlugin(),super.updatePlugin()}onAfterChange(e,t){if(e){let o=[];for(let t=0;t<e.length;t++){let r=this.hot.getCellMeta(e[t][0],e[t][1]),n={row:r.row_id,column:r.col_id,oldValue:e[t][2],newValue:e[t][3],meta:r};delete n.meta.instance,o.push(n)}this._post(this.controllerUrl+"/afterchange",{changes:o,source:t})}}destroy(){super.destroy()}onDataSend(e){let t=this.hot.getSettings().dataSourceConnector.onDataSend;"function"==typeof t&&t(e)}_post(e,t){let o=new r;return o.url=e,o.method="POST",o.body=t,o.headers=["application/json"],this._request(o).then(e=>(this.onDataSend({reqest:o,response:JSSON.parse(e)}),e))}_get(e){var t=new r;return t.url=e,t.headers=["application/json"],this._request(t).then(e=>(this.onDataSend({reqest:t,response:JSSON.parse(e)}),e))}_request(e){return new Promise((t,o)=>{let r=new XMLHttpRequest;r.open(e.method||"GET",e.url),e.headers&&Object.keys(e.headers).forEach(t=>{r.setRequestHeader(t,e.headers[t])}),r.onload=(()=>{r.status>=200&&r.status<300?t(r.response):o(r.statusText)}),r.onerror=(()=>o(r.statusText)),r.send(e.body)})}}(e)})}]).default});
//# sourceMappingURL=datasource-connector.js.map