!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e():"function"==typeof define&&define.amd?define("DatasourceConector",[],e):"object"==typeof exports?exports.DatasourceConector=e():t.DatasourceConector=e()}(window,function(){return function(t){var e={};function o(s){if(e[s])return e[s].exports;var r=e[s]={i:s,l:!1,exports:{}};return t[s].call(r.exports,r,r.exports,o),r.l=!0,r.exports}return o.m=t,o.c=e,o.d=function(t,e,s){o.o(t,e)||Object.defineProperty(t,e,{configurable:!1,enumerable:!0,get:s})},o.r=function(t){Object.defineProperty(t,"__esModule",{value:!0})},o.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return o.d(e,"a",e),e},o.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},o.p="",o(o.s=0)}([function(t,e,o){"use strict";o.r(e);class s{constructor(t){this.url="",this.method="GET",this.headers=void 0!==t?t:{"Content-Type":"application/json"},this.body=""}}class r{constructor(t){this.controllerUrl=t,this.listeners=[],this.defaultHeaders={}}addListener(t){"function"==typeof t&&this.listeners.push(t)}onDataSend(...t){this.listeners&&this.listeners.length&&this.listeners.forEach(e=>{setTimeout(()=>{e(...t)},5)})}delete(t,e){let o=new s(this.defaultHeaders);return o.url=this.controllerUrl+t,o.method="DELETE",o.body=JSON.stringify(e),this.request(o).then(t=>(this.onDataSend({request:o,response:JSON.parse(t)}),JSON.parse(t)))}put(t,e){let o=new s(this.defaultHeaders);return o.url=this.controllerUrl+t,o.method="PUT",o.body=JSON.stringify(e),this.request(o).then(t=>(this.onDataSend({request:o,response:JSON.parse(t)}),JSON.parse(t)))}post(t,e){let o=new s(this.defaultHeaders);return o.url=this.controllerUrl+t,o.method="POST",o.body=JSON.stringify(e),this.request(o).then(t=>(this.onDataSend({request:o,response:JSON.parse(t)}),JSON.parse(t)))}get(t){let e=new s(this.defaultHeaders);return e.url=this.controllerUrl+t,this.request(e).then(t=>(this.onDataSend({request:e,response:JSON.parse(t)}),JSON.parse(t)))}request(t){return new Promise((e,o)=>{let s=new XMLHttpRequest;s.open(t.method||"GET",t.url),t.headers&&Object.keys(t.headers).forEach(e=>{s.setRequestHeader(e,t.headers[e])}),s.onload=(()=>{s.status>=200&&s.status<300?e(s.response):o(s.statusText)}),s.onerror=(()=>o(s.statusText)),s.send(t.body)})}}class l extends Handsontable.plugins.BasePlugin{constructor(t){super(t),this.http={},this.colHeaders=[],this.filters=[],this.sort={}}isEnabled(){let t=!!this.hot.getSettings().dataSourceConnector;if(t){let t=this.hot.getSettings().dataSourceConnector.controllerUrl;void 0!==this.hot.getSettings().dataSourceConnector.onDataSend&&this.hot.addHook("onDataSend",this.hot.getSettings().dataSourceConnector.onDataSend),this.http=new r(t),this.http.defaultHeaders=this.hot.getSettings().dataSourceConnector.requestHeaders;const e=this.hot;this.http.addListener((...t)=>{void 0!==e&&e.runHooks("onDataSend",t[0])})}return t}enablePlugin(){this.addHook("beforeColumnSort",()=>!1),this.addHook("beforeFilter",()=>!1),this.addHook("beforeRemoveCol",(t,e)=>this.onRemoveCol(t,e)),this.addHook("beforeRemoveRow",(t,e)=>this.onRemoveRow(t,e)),this.addHook("afterInit",()=>this.onAfterInit()),this.addHook("afterChange",(t,e)=>this.onAfterChange(t,e)),this.addHook("afterColumnSort",(t,e)=>this.onAfterColumnSort(t,e)),this.addHook("afterCreateRow",(t,e,o)=>this.onAfterCreateRow(t,e,o)),this.addHook("afterCreateCol",(t,e,o)=>this.onAfterCreateCol(t,e,o)),this.addHook("afterColumnMove",(t,e)=>this.onAfterColumnMove(t,e)),this.addHook("afterFilter",t=>this.onAfterFilter(t)),this.addHook("beforeRowMove",(t,e)=>this.onRowMove(t,e)),this.addHook("afterRowResize",(t,e,o)=>this.onRowResize(t,e,o)),this.addHook("afterMergeCells",(t,e,o)=>this.onMergeCell(t,e,o)),this.addHook("afterColumnResize",(t,e,o)=>this.onColumnResize(t,e,o)),this.addHook("beforeUnmergeCells",(t,e)=>this.onUnmergeCells(t,e)),this.addHook("afterSetCellMeta",(t,e,o,s)=>this.onSetMeta(t,e,o,s)),super.enablePlugin()}onAfterFilter(t){let e=hot.getPlugin("filters").conditionCollection.exportAllConditions();e.forEach((o,s)=>{e[s].column=this.colHeaders[t[s].column]}),this.filters=e;let o={sort:this.sort,filters:this.filters};this.http.post("/data",o).then(t=>{this._loadData(t)})}_move(t,e,o){if(o===e)return t;let s=t[e],r=o<e?-1:1;for(let s=e;s!==o;s+=r)t[s]=t[s+r];return t[o]=s,t}onAfterColumnMove(t,e){let o=[],s=0;for(s=0;s<t.length;s++)o.push(this.colHeaders[t[s]]);let r={columnNames:o,target:e};this.http.post("/column/move",r).then(t=>{this.colHeaders=t.data})}onAfterCreateCol(t,e,o){let s={index:t,amount:e,source:o},r=0===t?1:0;this.http.put("/column",s).then(e=>{let o=this.hot.getData().length;for(let s=0;s<o;s++)this.hot.setCellMeta(s,t,"row_id",this.hot.getCellMeta(s,r).row_id),this.hot.setCellMeta(s,t,"col_id",e.name)})}async onRemoveCol(t,e){let o=[];for(let s=0;s<e;s++)o.push(this.colHeaders[s+t]);try{if((await this.http.delete("/column",o)).data){let t=await this.http.post("/data");return this._loadData(t),!0}}catch(t){return!1}return!1}onAfterCreateRow(t,e,o){let s={index:t,amount:e,source:o};this.http.put("/row",s).then(e=>{let o=this.hot.getData()[t],s=1===t?2:1;for(let r=0;r<o.length;r++){let o=this.hot.getCellMeta(s,r).col_id;this.hot.setCellMeta(t,r,"row_id",e.id),this.hot.setCellMeta(t,r,"col_id",o),this.hot.setDataAtCell(t,r,e.data[o])}})}onColumnResize(t,e){let o={column:this.hot.getCellMeta(1,t).col_id,size:e};this.http.post("/column/resize",o)}onRemoveRow(t,e){let o=[];for(let s=0;s<e;s++)o.push(this.hot.getCellMeta(s+t,1).row_id);this.http.delete("/row",o).then(t=>!!t)}onRowMove(t,e){let o=[];for(let e=0;e<t.length;e++)o.push(this.hot.getCellMeta(t[e],1).row_id);let s={rowsMoved:o,target:e};this.http.post("/row/move",s)}onRowResize(t,e){let o={row:this.hot.getCellMeta(t,1).row_id,size:e};this.http.post("/row/resize",o)}onAfterColumnSort(t,e){this.sort=void 0!==e?{column:this.colHeaders[t],order:!0===e?"ASC":"DESC"}:{};let o={sort:this.sort,filters:this.filters};this.http.post("/data",o).then(t=>{this._loadData(t)})}onMergeCell(t,e){let o={column:this.hot.getCellMeta(e.row,e.col).col_id,row:this.hot.getCellMeta(e.row,e.col).row_id},s=[],r=this._normalizeRange(t);for(let t=r.from.row;t<=r.to.row;t++)for(let e=r.from.col;e<=r.to.col;e++)s.push({column:this.hot.getCellMeta(t,e).col_id,row:this.hot.getCellMeta(t,e).row_id});this.http.post("/cell/merge",{mergedParent:o,mergedCells:s})}_normalizeRange(t){let e,o;return t.from.row<t.to.row?(e=t.from,o=t.to):t.from.row>t.to.row?(e=t.to,o=t.from):t.from.row===t.to.row&&(t.from.col>t.to.col?(e=t.to,o=t.from):(e=t.from,o=t.to)),{from:e,to:o}}onUnmergeCells(t){let e={column:this.hot.getCellMeta(t.highlight.row,t.highlight.col).col_id,row:this.hot.getCellMeta(t.highlight.row,t.highlight.col).row_id},o=[];for(let e=t.from.row;e<=t.to.row;e++)for(let s=t.from.col;s<=t.to.col;s++)o.push({column:this.hot.getCellMeta(e,s).col_id,row:this.hot.getCellMeta(e,s).row_id});this.http.post("/cell/unmerge",{mergedParent:e,mergedCells:o})}_loadData(t){let e=t.data,o=e.map(t=>Object.values(t));this.hot.loadData(o);let s=Object.keys(e[0]);this.colHeaders=s;for(let o=0;o<e.length;o++)for(let r=0;r<s.length;r++)this.hot.setCellMeta(o,r,"row_id",e[o][t.rowId]),this.hot.setCellMeta(o,r,"col_id",s[r])}onAfterInit(){this.http.get("/settings").then(t=>{this.hot.updateSettings(t.data)}),this.http.post("/data").then(t=>{this._loadData(t)})}onSetMeta(t,e,o,s){let r={row:this.hot.getCellMeta(t,e).row_id,column:this.hot.getCellMeta(t,e).col_id,key:o,value:s};this.http.post("/cell/meta",r)}disablePlugin(){super.disablePlugin()}updatePlugin(){this.disablePlugin(),this.enablePlugin(),super.updatePlugin()}onAfterChange(t,e){if(t){let o=[];for(let e=0;e<t.length;e++){let s=this.hot.getCellMeta(t[e][0],t[e][1]),r={row:s.row_id,column:s.col_id,oldValue:t[e][2],newValue:t[e][3],meta:s};delete r.meta.instance,o.push(r)}this.http.post("/cell",{changes:o,source:e})}}destroy(){super.destroy()}}e.default=l;Handsontable.plugins.registerPlugin("DataSourceConnector",l)}]).default});
//# sourceMappingURL=datasource-connector.js.map